# ポリゴン・エリアレベル仕様

## 概要

地図上のポリゴンは「エリアレベル」を持つ。エリアレベルとは、そのポリゴンが表す地理的な粒度（広域〜細粒度）を示す概念であり、国・地域によって階層構造が異なる。

---

## エリアレベルの例

### 日本

| レベル | 名称 | 例 |
|--------|------|----|
| 1 | 国 | 日本 |
| 2 | 都道府県 | 東京都、大阪府 |
| 3 | 市区町村 | 渋谷区、横浜市 |
| 4 | 丁目 | 渋谷一丁目 |
| 5 | 街区・番地（任意） | - |

### 米国

| レベル | 名称 | 例 |
|--------|------|----|
| 1 | 国 | United States |
| 2 | 州（State） | California |
| 3 | 郡（County） | Los Angeles County |
| 4 | 市（City） | Los Angeles |
| 5 | 地区・ZIP Code | - |

### 備考

エリアレベルの体系は国・地域によって異なるため、**レベル定義はデータとして管理**し、ハードコードしない。

---

## データ設計（検討中）

### AreaLevel（エリアレベル定義）

```
AreaLevel {
  id          : 一意識別子
  name        : レベル名称（例: "都道府県"、"State"）
  rank        : 順序（数値が小さいほど広域）
  country     : 適用国コード（ISO 3166-1、null = 全国共通）
  description : 補足説明（任意）
}
```

### Area（エリア・ポリゴン実体）

```
Area {
  id            : 一意識別子（ハッシュ文字列、自動生成、変更不可）
  display_name  : 表示名（任意・ユーザーが自由に編集可能）
  level_id      : AreaLevel への参照
  parent_id     : 親 Area への参照（任意）※子から親を参照
  geometry      : ポリゴン座標列（GeoJSON Polygon / MultiPolygon）
  metadata      : 拡張用 key-value（任意）
  created_at    : 作成日時
  updated_at    : 更新日時
}
```

#### ID の仕様

- 生成時に自動付与されるハッシュ文字列（例：UUID v4 または内容ベースのハッシュ）
- **変更不可**。システム全体でエリアを一意に識別する
- 外部データとの連携・インポート時も id は保持される

#### display_name の仕様

- **任意項目**。空でもよい
- ユーザーが自由に編集・変更できる
- 分割・生成直後はデフォルトで空または連番（例：`"エリア-1"`）
- 後からいつでも変更可能

---

## 親子関係

- **子から親を参照する**方向を基本とする（`parent_id` を子が持つ）
- 親から子の一覧を取得する場合は `parent_id` を検索する
- 階層は任意の深さを許容する
- 同一 AreaLevel 内での親子関係は持たない（レベルをまたいで親子になる）

### 例：東京都 → 渋谷区

```
Area { id: "tokyo",    name: "東京都", level_id: "pref",     parent_id: null }
Area { id: "shibuya",  name: "渋谷区", level_id: "city",     parent_id: "tokyo" }
Area { id: "shibuya1", name: "渋谷一丁目", level_id: "chome", parent_id: "shibuya" }
```

---

## 親ポリゴンの形状導出ルール

### 基本原則

> **親エリアのポリゴンは、子エリアポリゴン群の和集合（Union）の外輪郭として定義される。**

親ポリゴンは子から**自動的に導出**されるものであり、独立して定義・編集するものではない。

### 連続エリアの場合（Polygon）

子ポリゴンが互いに隣接・連続している場合、親ポリゴンは単一の `Polygon` になる。

```
子: 渋谷一丁目 ■ 渋谷二丁目 ■ 渋谷三丁目
         ↓ Union
親: 渋谷区 ■■■  （単一 Polygon）
```

### 飛び地がある場合（MultiPolygon）

子ポリゴンが空間的に不連続（飛び地）の場合、親ポリゴンは `MultiPolygon` になる。

```
子: エリアA ■   ■ エリアB（飛び地）
         ↓ Union
親: 親エリア ■   ■  （MultiPolygon）
```

**MultiPolygon は必須要件である。** 以下のような実在ケースが日常的に存在する：

| ケース | 例 |
|--------|----|
| 離島 | 東京都（本土 + 伊豆諸島 + 小笠原諸島） |
| 埋め立て地 | 大阪市此花区（陸地部 + 夢洲・舞洲） |
| 飛び地行政区 | 一部の市町村が他の市町村に囲まれた区域を持つ場合 |

これらは例外的なケースではなく、**地図ライブラリとして当然サポートすべき通常ケース**として扱う。

### geometry フィールドの扱い

| 状況 | geometry の型 | 定義方法 |
|------|--------------|---------|
| 葉ノード（子を持たないエリア） | Polygon または MultiPolygon | 直接定義・直接編集 |
| 中間ノード（子を持つエリア） | Polygon または MultiPolygon | 子 geometry の Union から自動計算 |
| ルートノード（国など） | 同上 | 同上 |

- 中間ノードの `geometry` はキャッシュとして保持してよいが、**正とするのは子の Union 計算結果**
- 子の編集時には親の `geometry` キャッシュを再計算する

### 葉ノードから中間ノードへの昇格

子を持たない葉ノードに初めて子追加操作（`splitAsChildren` / `expandWithChild`）を行うと、
そのノードは**中間ノードに昇格**する。

- 元の geometry は**子1として新規 Area に移譲**される
- 親自身の geometry は以降、子の Union として管理される
- 親エリアの identity（id・name・level_id・parent_id 等）はそのまま保たれる

### 境界の共有

隣接する兄弟エリア（同じ親を持つエリア）は**境界線を共有する**。
重複・オーバーラップは許容しない。Union 計算により内部境界は消去される。

#### ドーナツ形エリアと内側エリアの共有境界

一方の兄弟エリアが穴あきポリゴン（ドーナツ形）で、
他方がその穴を埋める内側ポリゴンである場合も、境界線を共有する兄弟として扱う。

```
例：イタリア（ドーナツ）とバチカン市国（内側）
  ┌───────────────────────┐
  │      Italy            │
  │    ┌────────┐         │
  │    │Vatican │  ← 兄弟エリア（Italy の穴 = Vatican の外輪郭）
  │    └────────┘         │
  └───────────────────────┘

Italy.geometry   = Polygon（外輪郭 + 穴リング）
Vatican.geometry = Polygon（外輪郭 = Italy の穴と同一座標）

Union(Italy, Vatican) = 親エリアの geometry ✓
```

- イタリアの穴リング（interior ring）とバチカンの外輪郭は同一座標を共有
- `sharedEdgeMove` によりこの共有境界の連動編集が適用される
- `Union` 計算でイタリアの穴はバチカンで埋まり、内部境界が消去される

---

## 未決事項

- [ ] AreaLevel の rank はグローバル共通か、国別か
- [ ] 既存の行政区画データ（GeoJSON）のインポート仕様
- [ ] 親 geometry キャッシュの再計算タイミング（リアルタイムか、非同期バッチか）
- [ ] 葉ノードのポリゴン編集時に上位階層のキャッシュをどこまで遡って再計算するか
